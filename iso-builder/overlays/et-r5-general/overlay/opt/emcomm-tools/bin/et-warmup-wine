#!/bin/bash
#
# Author  : Sylvain Deguire (VA2OPS)
# Date    : January 2026
# Purpose : Pre-initialize Wine and VARA on first boot
#           This prevents timeouts and errors when using VARA for the first time
#
# This script should run once after user creation (via et-user or first login)
#

SCRIPT_VERSION="1.0.0"
MARKER_FILE="$HOME/.config/emcomm-tools/.wine-initialized"
LOG_FILE="$HOME/.config/emcomm-tools/warmup.log"

# Wine settings
export WINEPREFIX="$HOME/.wine32"
export WINEARCH="win32"

# VARA paths
VARA_HF_EXE="$WINEPREFIX/drive_c/VARA/VARA.exe"
VARA_FM_EXE="$WINEPREFIX/drive_c/VARA FM/VARAFM.exe"

# Warmup duration (seconds to let each app initialize)
WARMUP_TIME=15

# Colors for terminal output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() {
    local msg="$(date '+%Y-%m-%d %H:%M:%S') - $1"
    echo -e "$msg"
    echo "$msg" >> "$LOG_FILE"
}

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$MARKER_FILE")"

# Check if already initialized
if [ -f "$MARKER_FILE" ]; then
    log "Wine/VARA already initialized. Skipping warmup."
    exit 0
fi

echo ""
echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║     EmComm-Tools - First Boot Wine/VARA Initialization        ║${NC}"
echo -e "${CYAN}╠════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${CYAN}║  This process will initialize Wine and VARA modems.           ║${NC}"
echo -e "${CYAN}║  This only happens once and takes about 1-2 minutes.          ║${NC}"
echo -e "${CYAN}║                                                                ║${NC}"
echo -e "${CYAN}║  Please wait... Do not close this window.                     ║${NC}"
echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""

log "Starting Wine/VARA warmup process..."

# Step 1: Initialize Wine prefix
log "Step 1/4: Initializing Wine prefix..."
if [ -d "$WINEPREFIX" ]; then
    # Run wineboot to ensure Wine is fully initialized
    wineboot --init 2>/dev/null &
    WINEBOOT_PID=$!
    sleep 10
    
    # Kill wineboot if still running
    if kill -0 $WINEBOOT_PID 2>/dev/null; then
        kill $WINEBOOT_PID 2>/dev/null
    fi
    wait $WINEBOOT_PID 2>/dev/null
    log "Wine prefix initialized."
else
    log "WARNING: Wine prefix not found at $WINEPREFIX"
fi

# Step 2: Warm up VARA HF
if [ -f "$VARA_HF_EXE" ]; then
    log "Step 2/4: Warming up VARA HF (${WARMUP_TIME}s)..."
    
    # Start VARA HF in background
    wine "$VARA_HF_EXE" 2>/dev/null &
    VARA_HF_PID=$!
    
    # Wait for warmup period
    sleep $WARMUP_TIME
    
    # Gracefully close VARA HF
    if kill -0 $VARA_HF_PID 2>/dev/null; then
        # Try graceful close first
        wineserver -k 2>/dev/null || kill $VARA_HF_PID 2>/dev/null
    fi
    wait $VARA_HF_PID 2>/dev/null
    
    # Give Wine a moment to settle
    sleep 3
    
    log "VARA HF warmup complete."
else
    log "Step 2/4: VARA HF not found, skipping."
fi

# Step 3: Warm up VARA FM
if [ -f "$VARA_FM_EXE" ]; then
    log "Step 3/4: Warming up VARA FM (${WARMUP_TIME}s)..."
    
    # Start VARA FM in background
    wine "$VARA_FM_EXE" 2>/dev/null &
    VARA_FM_PID=$!
    
    # Wait for warmup period
    sleep $WARMUP_TIME
    
    # Gracefully close VARA FM
    if kill -0 $VARA_FM_PID 2>/dev/null; then
        wineserver -k 2>/dev/null || kill $VARA_FM_PID 2>/dev/null
    fi
    wait $VARA_FM_PID 2>/dev/null
    
    # Give Wine a moment to settle
    sleep 3
    
    log "VARA FM warmup complete."
else
    log "Step 3/4: VARA FM not found, skipping."
fi

# Step 4: Final Wine cleanup
log "Step 4/4: Finalizing Wine initialization..."
wineserver -w 2>/dev/null  # Wait for all Wine processes to finish
sleep 2

# Mark as initialized
echo "Initialized on $(date)" > "$MARKER_FILE"
log "Wine/VARA initialization complete!"

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║              Initialization Complete!                          ║${NC}"
echo -e "${GREEN}║                                                                ║${NC}"
echo -e "${GREEN}║  Wine and VARA are now ready for use.                         ║${NC}"
echo -e "${GREEN}║  You can start Pat Winlink and use VARA without delays.       ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
echo ""

log "Warmup script finished successfully."
