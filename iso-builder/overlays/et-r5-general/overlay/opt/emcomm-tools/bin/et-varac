#!/bin/bash
#
# Author  : Sylvain Deguire (VA2OPS)
# Date    : January 2025
# Modified: January 2026
# Purpose : Wrapper script for starting VarAC with PnP support
#
# VarAC is a Windows app running under Wine.
# Wine uses ALSA underneath - et-audio MUST configure mixer levels!
# VARA modem handles CAT/PTT directly - no rigctld needed!
#
# VarAC is proprietary software by Irad Deutsch (4Z1AC).
# Distribution authorized under Limited Distribution Agreement.
#
# Preconditions
# 1. VARA modem and VarAC are installed in Wine prefix
# 2. License agreement must be accepted on first run
#
# Postconditions
# 1. Stop all running EmComm Tools modes
# 2. VarAC configuration updated (callsign, grid)
# 3. VARA modem started
# 4. VarAC started

. /opt/emcomm-tools/bin/et-common

# Wine prefix
if [ -n "$WINEPREFIX" ]; then
    WINE_PREFIX="$WINEPREFIX"
elif [ -d "${HOME}/.wine32" ]; then
    WINE_PREFIX="${HOME}/.wine32"
else
    WINE_PREFIX="${HOME}/.wine32"
fi

export WINEPREFIX="${WINE_PREFIX}"

VARAC_DIR="${WINE_PREFIX}/drive_c/VarAC"
VARAC_INI="${VARAC_DIR}/VarAC.ini"
VARAC_EXE="${VARAC_DIR}/VarAC.exe"
VARA_DIR="${WINE_PREFIX}/drive_c/VARA"
VARA_EXE="${VARA_DIR}/VARA.exe"

# =============================================================================
# License Agreement Configuration
# =============================================================================

LICENSE_FILE="${VARAC_DIR}/License.txt"
ET_CONFIG_DIR="${HOME}/.config/emcomm-tools/varac"
LICENSE_FLAG="${ET_CONFIG_DIR}/license.flag"
AUDIT_LOG="${ET_CONFIG_DIR}/license-audit.log"

# Protection settings
# Change to "true" to enable removal of VarAC on decline
ENABLE_REMOVAL_ON_DECLINE="false"

# Salt for hash validation
HASH_SALT="EmCommTools-VA2OPS-VarAC-LDA-2026"

# =============================================================================
# License Agreement Functions
# =============================================================================

log_audit() {
    local action="$1"
    local details="$2"
    local timestamp
    timestamp=$(date -u "+%Y-%m-%dT%H:%M:%SZ")
    local machine_id
    machine_id=$(cat /etc/machine-id 2>/dev/null | head -c 8 || echo "unknown")
    
    mkdir -p "${ET_CONFIG_DIR}"
    echo "${timestamp}|${action}|${machine_id}|${details}" >> "${AUDIT_LOG}"
}

generate_hash() {
    local license_content="$1"
    local machine_id
    machine_id=$(cat /etc/machine-id 2>/dev/null || echo "fallback-id")
    
    # Create hash from: license content + machine ID + salt
    echo -n "${license_content}${machine_id}${HASH_SALT}" | sha256sum | cut -d' ' -f1
}

create_license_flag() {
    local license_content="$1"
    local hash
    hash=$(generate_hash "${license_content}")
    local timestamp
    timestamp=$(date -u "+%Y-%m-%dT%H:%M:%SZ")
    
    mkdir -p "${ET_CONFIG_DIR}"
    chmod 700 "${ET_CONFIG_DIR}"
    
    # Create flag file with validation data
    cat > "${LICENSE_FLAG}" << EOF
# VarAC License Acceptance Flag
# DO NOT MODIFY - Tampering will require re-acceptance
# Generated by EmComm-Tools Debian Edition
ACCEPTED_DATE=${timestamp}
VALIDATION_HASH=${hash}
EOF
    
    chmod 600 "${LICENSE_FLAG}"
}

validate_license_flag() {
    if [[ ! -f "${LICENSE_FLAG}" ]]; then
        return 1
    fi
    
    if [[ ! -f "${LICENSE_FILE}" ]]; then
        log_audit "ERROR" "License file missing: ${LICENSE_FILE}"
        return 1
    fi
    
    # Read stored hash
    local stored_hash
    stored_hash=$(grep "^VALIDATION_HASH=" "${LICENSE_FLAG}" 2>/dev/null | cut -d'=' -f2)
    
    if [[ -z "${stored_hash}" ]]; then
        log_audit "TAMPER_DETECTED" "Flag file corrupted or missing hash"
        return 1
    fi
    
    # Generate current hash
    local license_content
    license_content=$(cat "${LICENSE_FILE}")
    local current_hash
    current_hash=$(generate_hash "${license_content}")
    
    # Compare hashes
    if [[ "${stored_hash}" != "${current_hash}" ]]; then
        log_audit "TAMPER_DETECTED" "Hash mismatch - flag or license modified"
        return 1
    fi
    
    return 0
}

show_license_dialog() {
    local license_content="$1"
    
    local dialog_title="VarAC - License Agreement"

    # First show the license text
    echo "${license_content}" | zenity --text-info \
        --title="${dialog_title}" \
        --width=750 \
        --height=440 \
        --checkbox="I have read and accept the license agreement"
    
    return $?
}

show_removal_warning() {
    zenity --question \
        --title="VarAC Removal Confirmation" \
        --width=450 \
        --text="<b>You have declined the VarAC License Agreement.</b>\n\nAs per the distribution terms, VarAC will now be removed from your system.\n\nThis action cannot be undone.\n\nClick OK to remove VarAC, or Cancel to exit."
    
    return $?
}

remove_varac() {
    log_audit "REMOVAL_STARTED" "User declined license, initiating removal"
    
    if [[ -d "${VARAC_DIR}" ]]; then
        rm -rf "${VARAC_DIR}"
        log_audit "REMOVAL_COMPLETE" "VarAC directory removed: ${VARAC_DIR}"
        
        zenity --info \
            --title="VarAC Removed" \
            --width=400 \
            --text="VarAC has been removed from your system.\n\nIf you wish to use VarAC in the future, you will need to reinstall it and accept the license agreement."
    else
        log_audit "REMOVAL_SKIPPED" "VarAC directory not found"
    fi
}

show_license_error() {
    local message="$1"
    
    # Try zenity first, fallback to notify-send
    if command -v zenity &> /dev/null; then
        zenity --error \
            --title="VarAC License Error" \
            --width=400 \
            --text="${message}"
    else
        notify-send -t 10000 --app-name="EmComm Tools" "VarAC License Error: ${message}"
    fi
}

# Check and enforce license agreement
# Returns 0 if license accepted, 1 if declined or error
check_license_agreement() {
    # Check if zenity is installed (for license dialog)
    if ! command -v zenity &> /dev/null; then
        et-log "ERROR: zenity not installed for license dialog"
        notify-send -t 10000 --app-name="EmComm Tools" \
            "VarAC requires 'zenity' for license dialog. Install with: sudo apt install zenity"
        return 1
    fi
    
    # Check if license file exists
    if [[ ! -f "${LICENSE_FILE}" ]]; then
        et-log "License file not found: ${LICENSE_FILE}"
        show_license_error "License file not found.\n\nExpected location:\n${LICENSE_FILE}"
        log_audit "ERROR" "License file not found"
        return 1
    fi
    
    # Read license content
    local license_content
    license_content=$(cat "${LICENSE_FILE}")
    
    # Check if license was already accepted
    if [[ -f "${LICENSE_FLAG}" ]]; then
        if validate_license_flag; then
            # Valid acceptance, proceed
            et-log "VarAC license previously accepted"
            return 0
        else
            # Tampering detected, remove flag and show license again
            rm -f "${LICENSE_FLAG}"
            log_audit "FLAG_RESET" "Invalid flag removed, requiring re-acceptance"
            et-log "License flag invalid, requiring re-acceptance"
        fi
    fi
    
    # Show license dialog
    et-log "Showing VarAC license agreement dialog..."
    if show_license_dialog "${license_content}"; then
        # User accepted
        create_license_flag "${license_content}"
        log_audit "ACCEPTED" "License agreement accepted by user"
        et-log "VarAC license agreement accepted"
        return 0
    else
        # User declined
        log_audit "DECLINED" "License agreement declined by user"
        et-log "VarAC license agreement declined"
        
        if [[ "${ENABLE_REMOVAL_ON_DECLINE}" == "true" ]]; then
            if show_removal_warning; then
                remove_varac
            else
                log_audit "REMOVAL_CANCELLED" "User cancelled removal"
            fi
        fi
        
        return 1
    fi
}

# =============================================================================
# Original Functions
# =============================================================================

usage() {
  echo "usage: $(basename $0) <command>"
  echo "  start           - Update config and start VarAC"
  echo "  update-config   - Update config only"
  echo "  status          - Show installation status"
  echo "  license-status  - Show license acceptance status"
}

if [ $# -ne 1 ]; then
  usage
  exit 1
fi

notify_user() {
  notify-send \
   -t 5000 \
   --app-name="EmComm Tools" \
   "$1"
}

check_installation() {
  local varac_ok=false
  local vara_ok=false
    
  [ -f "${VARAC_EXE}" ] && varac_ok=true
  [ -f "${VARA_EXE}" ] && vara_ok=true
    
  if [ "$varac_ok" = false ]; then
    et-log "VarAC not installed at ${VARAC_EXE}"
    notify_user "VarAC not installed. Run: et-get-vara"
    
    # Offer to install
    if [ -x "/opt/emcomm-tools/bin/et-get-vara" ]; then
      echo ""
      echo "VarAC is not installed."
      read -p "Install VARA/VarAC now? [Y/n]: " response
      if [ -z "$response" ] || [ "$response" = "y" ] || [ "$response" = "Y" ]; then
        /opt/emcomm-tools/bin/et-get-vara
        # Re-check after install
        [ -f "${VARAC_EXE}" ] && return 0
      fi
    fi
    return 1
  fi
    
  if [ "$vara_ok" = false ]; then
    et-log "VARA modem not installed at ${VARA_EXE}"
    notify_user "Warning: VARA modem not installed. VarAC needs VARA to function."
    # Continue anyway - user might want to configure first
  fi
    
  return 0
}

show_status() {
  echo ""
  echo "=== VarAC/VARA Installation Status ==="
  echo "Wine Prefix: ${WINE_PREFIX}"
  echo ""
  
  if [ -f "${VARAC_EXE}" ]; then
    echo "VarAC:   INSTALLED"
  else
    echo "VarAC:   NOT INSTALLED"
  fi
  
  if [ -f "${VARA_EXE}" ]; then
    echo "VARA HF: INSTALLED"
  else
    echo "VARA HF: NOT INSTALLED"
  fi
  
  if [ -f "${WINE_PREFIX}/drive_c/VARA FM/VARAFM.exe" ]; then
    echo "VARA FM: INSTALLED"
  else
    echo "VARA FM: NOT INSTALLED"
  fi
  
  echo ""
  
  # Show user config
  [ -z "$ET_USER_CONFIG" ] && ET_USER_CONFIG="${HOME}/.config/emcomm-tools/user.json"
  if [ -f "${ET_USER_CONFIG}" ]; then
    CALLSIGN=$(cat ${ET_USER_CONFIG} | jq -r .callsign 2>/dev/null)
    GRID=$(cat ${ET_USER_CONFIG} | jq -r .grid 2>/dev/null)
    echo "User Config (user.json):"
    echo "  Callsign: ${CALLSIGN:-not set}"
    echo "  Grid:     ${GRID:-not set}"
  else
    echo "User Config: NOT CONFIGURED"
    echo "  Run 'et-user' to configure"
  fi
  
  # Show radio config
  ACTIVE_RADIO="/opt/emcomm-tools/conf/radios.d/active-radio.json"
  if [ -f "${ACTIVE_RADIO}" ]; then
    MODEL=$(jq -r '.model // ""' "${ACTIVE_RADIO}" 2>/dev/null)
    echo ""
    echo "Active Radio:"
    if [ -n "${MODEL}" ] && [ "${MODEL}" != "null" ]; then
      echo "  ${MODEL}"
    else
      echo "  (unknown)"
    fi
  else
    echo ""
    echo "Active Radio: NOT CONFIGURED"
    echo "  Run 'et-radio' to configure"
  fi
  
  echo ""
}

show_license_status() {
  echo ""
  echo "=== VarAC License Status ==="
  echo ""
  
  if [[ -f "${LICENSE_FILE}" ]]; then
    echo "License File: PRESENT"
    echo "  Location: ${LICENSE_FILE}"
  else
    echo "License File: NOT FOUND"
  fi
  
  echo ""
  
  if [[ -f "${LICENSE_FLAG}" ]]; then
    if validate_license_flag; then
      local accepted_date
      accepted_date=$(grep "^ACCEPTED_DATE=" "${LICENSE_FLAG}" 2>/dev/null | cut -d'=' -f2)
      echo "License Status: ACCEPTED"
      echo "  Accepted On: ${accepted_date}"
    else
      echo "License Status: INVALID (tampering detected)"
    fi
  else
    echo "License Status: NOT ACCEPTED"
  fi
  
  echo ""
  
  if [[ -f "${AUDIT_LOG}" ]]; then
    echo "Recent Audit Log (last 5 entries):"
    tail -5 "${AUDIT_LOG}" | while read line; do
      echo "  ${line}"
    done
  else
    echo "Audit Log: No entries"
  fi
  
  echo ""
}

start() {

  # Check if VarAC is installed
  if ! check_installation; then
    exit 1
  fi

  # Check license agreement BEFORE launching
  if ! check_license_agreement; then
    et-log "VarAC launch aborted: license not accepted"
    exit 1
  fi

  # Log successful launch
  log_audit "LAUNCHED" "VarAC started successfully"

  # Kill other modes, update config, and start - ALL BACKGROUNDED
  # The & at the end backgrounds the entire chain so et-kill-all doesn't terminate us
  /opt/emcomm-tools/bin/et-kill-all && update-config && start_varac &

}

start_varac() {
  # Configure ALSA mixer for USB audio device (Digirig, etc.)
  if [[ -e /dev/et-audio ]]; then
    et-log "Configuring audio device..."
    /opt/emcomm-tools/bin/et-audio update-config
  fi

  # Start VarAC (it will start VARA modem automatically)
  et-log "Starting VarAC..."
  cd "${VARAC_DIR}"
  wine "${VARAC_EXE}" &
  
  notify_user "VarAC started"
}

update-config() {

    [ -z "$ET_USER_CONFIG" ] && ET_USER_CONFIG="${HOME}/.config/emcomm-tools/user.json"

    # Update configuration with current callsign and grid
    CALLSIGN=$(cat ${ET_USER_CONFIG} | jq -r .callsign 2>/dev/null)
    GRID=$(et-system-info grid 2>/dev/null)
    
    # Fallback to user.json grid if et-system-info fails
    if [ -z "${GRID}" ]; then
      GRID=$(cat ${ET_USER_CONFIG} | jq -r .grid 2>/dev/null)
    fi

    # Get radio model from active-radio.json
    ACTIVE_RADIO="/opt/emcomm-tools/conf/radios.d/active-radio.json"
    MYRIG=""
    if [ -f "${ACTIVE_RADIO}" ]; then
      MODEL=$(jq -r '.model // ""' "${ACTIVE_RADIO}" 2>/dev/null)
      if [ -n "${MODEL}" ] && [ "${MODEL}" != "null" ]; then
        MYRIG="${MODEL}"
      fi
    fi

    if [ "${CALLSIGN}" = "N0CALL" ] || [ -z "${CALLSIGN}" ] || [ "${CALLSIGN}" = "null" ]; then
      notify_user "Can't start VarAC. No callsign set. Run: et-user."
      exit 1
    fi

    # Update VarAC.ini if it exists
    if [ -f "${VARAC_INI}" ]; then
      # Backup
      cp "${VARAC_INI}" "${VARAC_INI}.bak"
      
      # Update Mycall
      if grep -qi "^Mycall=" "${VARAC_INI}"; then
        sed -i "s|^Mycall=.*|Mycall=${CALLSIGN}|i" ${VARAC_INI}
      elif grep -qi "^\[MY_INFO\]" "${VARAC_INI}"; then
        sed -i "/^\[MY_INFO\]/a Mycall=${CALLSIGN}" ${VARAC_INI}
      else
        echo -e "\n[MY_INFO]\nMycall=${CALLSIGN}" >> ${VARAC_INI}
      fi
      
      # Update MyLocator
      if grep -qi "^MyLocator=" "${VARAC_INI}"; then
        sed -i "s|^MyLocator=.*|MyLocator=${GRID}|i" ${VARAC_INI}
      elif grep -qi "^\[MY_INFO\]" "${VARAC_INI}"; then
        sed -i "/^\[MY_INFO\]/a MyLocator=${GRID}" ${VARAC_INI}
      fi

      # Update MyRIG (if radio is selected)
      if [ -n "${MYRIG}" ]; then
        if grep -qi "^MyRIG=" "${VARAC_INI}"; then
          sed -i "s|^MyRIG=.*|MyRIG=${MYRIG}|i" ${VARAC_INI}
        elif grep -qi "^\[MY_INFO\]" "${VARAC_INI}"; then
          sed -i "/^\[MY_INFO\]/a MyRIG=${MYRIG}" ${VARAC_INI}
        fi
      fi

      et-log "Updated VarAC configuration with callsign '${CALLSIGN}', grid: '${GRID}', rig: '${MYRIG}'"
    else
      et-log "VarAC.ini not found. Will be created on first run."
    fi

}

case $1 in
  start)
    start
    ;;
  update-config)
    update-config
    ;;
  status)
    show_status
    ;;
  license-status)
    show_license_status
    ;;
  *)
    echo "Invalid command."
    usage
    exit 1
  ;;
esac
