#!/usr/bin/env python3
"""
et-dashboard - EmComm-Tools Interactive Dashboard
Author: Sylvain Deguire (VA2OPS)
Date: January 2026

Replaces Conky with a clickable GTK dashboard
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, GLib, Gdk, Pango
import subprocess
import os
import json

class EmCommDashboard(Gtk.Window):
    def __init__(self):
        super().__init__(title="EmComm Dashboard")
        
        # Window setup - desktop widget style (like Conky)
        self.set_decorated(False)
        self.set_skip_taskbar_hint(True)
        self.set_skip_pager_hint(True)
        self.set_keep_below(True)
        self.set_type_hint(Gdk.WindowTypeHint.DOCK)  # Behaves like a dock/panel
        self.stick()
        self.set_accept_focus(False)  # Don't steal focus from other apps
        
        # Prevent accidental closing
        self.connect("delete-event", self.on_delete_event)
        
        # Position top-right
        screen = Gdk.Screen.get_default()
        width = 350
        self.set_default_size(width, -1)
        self.move(screen.get_width() - width - 10, 10)
        
        # Transparent background
        self.set_app_paintable(True)
        screen = self.get_screen()
        visual = screen.get_rgba_visual()
        if visual:
            self.set_visual(visual)
        
        # Apply CSS styling
        self.apply_css()
        
        # Main container
        self.main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.main_box.set_name("dashboard")
        self.add(self.main_box)
        
        # Build UI
        self.build_ui()
        
        # Start update timer
        GLib.timeout_add_seconds(2, self.update_info)
        
    def apply_css(self):
        css = b"""
        #dashboard {
            background-color: rgba(30, 30, 30, 0.85);
            border-radius: 8px;
            padding: 15px;
        }
        .section-header {
            color: #CCCCCC;
            font-weight: bold;
            font-size: 16px;
        }
        .info-label {
            color: #888888;
            font-family: monospace;
            font-size: 16px;
        }
        .callsign {
            color: #FFA500;
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
        }
        .status-ok {
            color: #00CC00;
        }
        .status-error {
            color: #CC0000;
        }
        .utc-time {
            color: #888888;
            font-family: monospace;
            font-size: 18px;
        }
        .config-button {
            padding: 6px 12px;
            min-height: 0;
            min-width: 0;
            font-size: 14px;
        }
        .app-button {
            padding: 8px 14px;
            font-size: 14px;
            font-weight: bold;
        }
        .separator {
            background-color: #444444;
            min-height: 1px;
        }
        """
        style_provider = Gtk.CssProvider()
        style_provider.load_from_data(css)
        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            style_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )
    
    def build_ui(self):
        # === UTC / GPS Section ===
        time_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
        time_box.set_margin_bottom(5)
        
        self.utc_label = Gtk.Label()
        self.utc_label.set_name("utc-time")
        self.utc_label.get_style_context().add_class("utc-time")
        time_box.pack_start(self.utc_label, False, False, 0)
        
        self.gps_label = Gtk.Label()
        self.gps_label.get_style_context().add_class("info-label")
        time_box.pack_end(self.gps_label, False, False, 0)
        
        self.main_box.pack_start(time_box, False, False, 0)
        self.main_box.pack_start(self.create_separator(), False, False, 5)
        
        # === INTERFACES Section ===
        iface_header = self.create_section_header("INTERFACES", self.on_radio_clicked)
        self.main_box.pack_start(iface_header, False, False, 0)
        
        self.iface_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        self.iface_box.set_margin_start(5)
        self.iface_box.set_margin_bottom(5)
        
        self.radio_label = self.create_info_row("Radio")
        self.cat_label = self.create_info_row("CAT")
        self.audio_label = self.create_info_row("Audio")
        
        self.iface_box.pack_start(self.radio_label, False, False, 0)
        self.iface_box.pack_start(self.cat_label, False, False, 0)
        self.iface_box.pack_start(self.audio_label, False, False, 0)
        
        self.main_box.pack_start(self.iface_box, False, False, 0)
        self.main_box.pack_start(self.create_separator(), False, False, 5)
        
        # === OPERATOR Section ===
        op_header = self.create_section_header("OPERATOR", self.on_user_clicked)
        self.main_box.pack_start(op_header, False, False, 0)
        
        self.op_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
        self.op_box.set_margin_start(5)
        self.op_box.set_margin_bottom(5)
        
        self.callsign_label = Gtk.Label()
        self.callsign_label.get_style_context().add_class("callsign")
        self.op_box.pack_start(self.callsign_label, False, False, 0)
        
        self.grid_label = Gtk.Label()
        self.grid_label.get_style_context().add_class("info-label")
        self.op_box.pack_start(self.grid_label, False, False, 0)
        
        self.main_box.pack_start(self.op_box, False, False, 0)
        self.main_box.pack_start(self.create_separator(), False, False, 5)
        
        # === MODE Section ===
        mode_header = self.create_section_header("MODE", self.on_mode_clicked)
        self.main_box.pack_start(mode_header, False, False, 0)
        
        self.mode_label = Gtk.Label()
        self.mode_label.set_halign(Gtk.Align.START)
        self.mode_label.get_style_context().add_class("info-label")
        self.mode_label.set_margin_start(5)
        self.mode_label.set_margin_bottom(5)
        self.main_box.pack_start(self.mode_label, False, False, 0)
        
        self.main_box.pack_start(self.create_separator(), False, False, 5)
        
        # === Quick Launch Buttons ===
        button_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=4)
        button_box.set_halign(Gtk.Align.CENTER)
        
        apps = [
            ("Winlink", self.on_winlink_clicked),
            ("JS8", self.on_js8_clicked),
            ("VarAC", self.on_varac_clicked),
            ("BBS", self.on_bbs_clicked),
        ]
        
        for name, callback in apps:
            btn = Gtk.Button(label=name)
            btn.get_style_context().add_class("app-button")
            btn.connect("clicked", callback)
            button_box.pack_start(btn, False, False, 0)
        
        self.main_box.pack_start(button_box, False, False, 5)
        
        # Initial update
        self.update_info()
    
    def create_section_header(self, title, callback):
        box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=5)
        
        label = Gtk.Label(label=title)
        label.get_style_context().add_class("section-header")
        box.pack_start(label, False, False, 0)
        
        btn = Gtk.Button(label="⚙")
        btn.get_style_context().add_class("config-button")
        btn.set_tooltip_text("Configure")
        btn.connect("clicked", callback)
        box.pack_end(btn, False, False, 0)
        
        return box
    
    def create_info_row(self, label_text):
        label = Gtk.Label()
        label.set_halign(Gtk.Align.START)
        label.get_style_context().add_class("info-label")
        label.set_markup(f"<span>{label_text}: --</span>")
        return label
    
    def create_separator(self):
        sep = Gtk.Separator(orientation=Gtk.Orientation.HORIZONTAL)
        sep.get_style_context().add_class("separator")
        return sep
    
    def run_command(self, cmd):
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            return result.stdout.strip()
        except Exception:
            return ""
    
    def update_info(self):
        # UTC Time
        utc = self.run_command("date -u '+%H:%M:%S'")
        self.utc_label.set_text(f"UTC: {utc}")
        
        # GPS Status
        gps = self.run_command("et-system-info et-gps 2>/dev/null")
        if gps and "not" not in gps.lower():
            self.gps_label.set_markup("<span foreground='#00CC00'>GPS: ✓</span>")
        else:
            self.gps_label.set_markup("<span foreground='#CC0000'>GPS: ✗</span>")
        
        # Radio
        radio = self.run_command("et-system-info active-radio 2>/dev/null") or "Not configured"
        self.radio_label.set_markup(f"<span foreground='#888888'>Radio: {radio}</span>")
        
        # CAT
        cat = self.run_command("et-system-info et-cat 2>/dev/null")
        if cat and "not" not in cat.lower():
            self.cat_label.set_markup(f"<span foreground='#888888'>CAT: </span><span foreground='#00CC00'>✓</span>")
        else:
            self.cat_label.set_markup(f"<span foreground='#888888'>CAT: </span><span foreground='#CC0000'>✗</span>")
        
        # Audio
        audio = self.run_command("et-system-info et-audio 2>/dev/null")
        if audio and "not" not in audio.lower():
            self.audio_label.set_markup(f"<span foreground='#888888'>Audio: </span><span foreground='#00CC00'>✓</span>")
        else:
            self.audio_label.set_markup(f"<span foreground='#888888'>Audio: </span><span foreground='#CC0000'>✗</span>")
        
        # Operator info
        try:
            config_path = os.path.expanduser("~/.config/emcomm-tools/user.json")
            if os.path.exists(config_path):
                with open(config_path) as f:
                    config = json.load(f)
                callsign = config.get("callsign", "N0CALL")
                grid = config.get("grid", "AA00aa")
            else:
                callsign = "N0CALL"
                grid = "AA00aa"
        except Exception:
            callsign = "N0CALL"
            grid = "AA00aa"
        
        self.callsign_label.set_text(callsign)
        self.grid_label.set_text(f"· {grid}")
        
        # Current mode
        mode = self.run_command("et-system-info et-mode 2>/dev/null") or "Not set"
        self.mode_label.set_text(mode)
        
        return True  # Continue timer
    
    def on_delete_event(self, widget, event):
        # Prevent closing - return True to block
        return True
    
    # === Click Handlers ===
    def on_radio_clicked(self, widget):
        subprocess.Popen(["xfce4-terminal", "--command=/opt/emcomm-tools/bin/et-radio"])
    
    def on_user_clicked(self, widget):
        subprocess.Popen(["xfce4-terminal", "--command=/opt/emcomm-tools/bin/et-user"])
    
    def on_mode_clicked(self, widget):
        subprocess.Popen(["xfce4-terminal", "--command=/opt/emcomm-tools/bin/et-mode"])
    
    def on_winlink_clicked(self, widget):
        subprocess.Popen(["/opt/emcomm-tools/bin/et-winlink", "start"])
    
    def on_js8_clicked(self, widget):
        subprocess.Popen(["/opt/emcomm-tools/bin/et-js8call", "start"])
    
    def on_varac_clicked(self, widget):
        subprocess.Popen(["/opt/emcomm-tools/bin/et-varac", "start"])
    
    def on_bbs_clicked(self, widget):
        subprocess.Popen(["/opt/emcomm-tools/bin/et-bbs", "start"])


def main():
    win = EmCommDashboard()
    # Don't connect destroy - we want it to stay running
    win.show_all()
    Gtk.main()


if __name__ == "__main__":
    main()
