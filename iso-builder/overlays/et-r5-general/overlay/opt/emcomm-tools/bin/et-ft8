#!/bin/bash
#
# Author  : Sylvain Deguire (VA2OPS)
# Date    : January 2025
# Updated : January 2026
# Purpose : Wrapper script for starting WSJT-X (FT8/FT4) with PnP support
#
# Based on et-js8call by Gaston Gonzalez
#
# Preconditions
# 1. Supported radio and audio interface are connected and properly detected
#
# Postconditions
# 1. Stop all running EmComm Tools modes
# 2. WSJT-X audio and CAT settings updated
# 3. WSJT-X started

. /opt/emcomm-tools/bin/et-common

usage() {
  echo "usage: $(basename $0) <command>"
  echo "  start           - Update config and start WSJT-X"
  echo "  update-config   - Update config only"
}

if [ $# -ne 1 ]; then
  usage
  exit 1
fi

notify_user() {
  notify-send \
   -t 5000 \
   --app-name="EmComm Tools" \
   "$1"
}

start() {

  # Ensure that we have a pre-initialized CAT control connection for select radios
  prime_rigctld_conn

  /opt/emcomm-tools/bin/et-kill-all && update-config && /usr/bin/wsjtx &

  if [ ! -e /dev/et-gps ]; then
    notify-send -u critical \
      "No GPS. Ensure your time is accurate when WSJT-X starts."
  fi

}

# Helper function to update or add a setting in the config file
update_setting() {
  local key="$1"
  local value="$2"
  local file="$3"
  
  if grep -q "^${key}=" "${file}"; then
    sed -i "s|^${key}=.*|${key}=${value}|" "${file}"
  else
    sed -i "/^\[Configuration\]/a ${key}=${value}" "${file}"
  fi
}

update-config() {

    # WSJT-X stores config directly in ~/.config/WSJT-X.ini (NO subdirectory!)
    WSJTX_CONF_FILE="${HOME}/.config/WSJT-X.ini"
   
    [ -z "$ET_USER_CONFIG" ] && ET_USER_CONFIG="${HOME}/.config/emcomm-tools/user.json"

    # Update configuration with current callsign and grid
    CALLSIGN=$(cat ${ET_USER_CONFIG} | jq -r .callsign)
    GRID=$(et-system-info grid)

    if [ "${CALLSIGN}" = "N0CALL" ] || [ -z "${CALLSIGN}" ]; then
      notify_user "Can't start WSJT-X. No callsign set. Run: et-user."
      exit 1
    fi

    # Create minimal config file if it doesn't exist
    if [ ! -f "${WSJTX_CONF_FILE}" ]; then
      cat > "${WSJTX_CONF_FILE}" << EOFCFG
[Configuration]
MyCall=${CALLSIGN}
MyGrid=${GRID}
EOFCFG
      et-log "Created new WSJT-X configuration file"
    fi

    # Update callsign and grid
    update_setting "MyCall" "${CALLSIGN}" "${WSJTX_CONF_FILE}"
    update_setting "MyGrid" "${GRID}" "${WSJTX_CONF_FILE}"

    et-log "Updated WSJT-X configuration with user callsign '${CALLSIGN}' and grid: '${GRID}'"

    # Configure CAT control via rigctld
    update_setting "Rig" "Hamlib NET rigctl" "${WSJTX_CONF_FILE}"
    update_setting "CATNetworkPort" "localhost:4532" "${WSJTX_CONF_FILE}"
    
    et-log "Updated WSJT-X CAT configuration for rigctld on localhost:4532"

    # 1. Check if the symlink was created by the udev rules
    if [ -e /dev/et-audio ]; then

       # 2. Check that this device was properly tagged with the ET_AUDIO env variable with a udev rule
       APLAY_OUT=$(arecord -l | grep ET_AUDIO)
       if [ $? -eq 0 ]; then
         AUDIO_DEVICE=$(echo $APLAY_OUT | cut -d"," -f2 | cut -d":" -f1 | awk '{print $2}')

         # Use same ALSA device format as JS8Call (Gaston's PnP approach)
         WSJTX_AUDIO_DEVICE="sysdefault:CARD=ET_AUDIO"
  
         et-log "Using '${WSJTX_AUDIO_DEVICE}' for WSJT-X configuration."

         # Update audio settings (with quotes around device name)
         update_setting "SoundInName" "\"${WSJTX_AUDIO_DEVICE}\"" "${WSJTX_CONF_FILE}"
         update_setting "SoundOutName" "\"${WSJTX_AUDIO_DEVICE}\"" "${WSJTX_CONF_FILE}"

         ## Configure ALSA settings for sound card
         /opt/emcomm-tools/bin/et-audio update-config

       else
         et-log "No ET_AUDIO device detected."
         notify_user "Can't start WSJT-X. No ET_AUDIO device detected."
         exit 1
       fi
    else
      et-log "No ET_AUDIO device plugged in."
      notify_user "Can't start WSJT-X. No supported audio device plugged in."
      exit 1
    fi

}

case $1 in
  start)
    start
    ;;
  update-config)
    update-config
    ;;
  *)
    echo "Invalid command."
    usage
    exit 1
  ;;
esac
